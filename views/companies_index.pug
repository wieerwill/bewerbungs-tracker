extends layout

block content
  .card
    .card-header
      h1 Unternehmen
      .buttons
        a.btn(href="/api/companies.csv" download) CSV Export
        button.btn#csv-import(type="button") CSV Import
        a.btn(href="/companies/new") + Neues Unternehmen

  // Suche (GET /companies?q=...)
  .card
    form(action="/companies", method="GET", role="search", aria-label="Suche", class="toolbar")
      span.muted Suche
      input#q(
        type="text"
        name="q"
        value=(typeof q !== 'undefined' ? q : '')
        placeholder="Name, Website, Ort ..."
        autocomplete="off"
        aria-label="Suche"
      )
      button.btn(type="submit") Anwenden
      a.btn.secondary(href="/companies") Zurücksetzen

  if companies && companies.length
    .table-wrap
      table.table(aria-describedby="companies-help")
        thead
          tr
            th(scope="col" style="width:3rem") #
            th(scope="col") Name
            th(scope="col") Website
            th(scope="col") Ort
            th(scope="col") Größe
            th(scope="col") Profile
            th(scope="col") Aktionen
        tbody
          each c, i in companies
            - const site = c.website ? (c.website.startsWith('http') ? c.website : `https://${c.website}`) : null
            tr
              td= i + 1
              td
                a.table-link(href=`/companies/${c._id}`)= c.name
              td
                if site
                  a.truncate(href=site rel="noopener noreferrer" title=c.website)= c.website
                else
                  | —
              td= c.city || '—'
              td= c.size_range || '—'
              td.nowrap
                if c.linkedin_url
                  a.pill(href=c.linkedin_url rel="noopener noreferrer" title="LinkedIn Profil")
                    span.sr-only LinkedIn:
                    | in
                if c.glassdoor_url
                  a.pill(href=c.glassdoor_url rel="noopener noreferrer" title="Glassdoor Profil")
                    span.sr-only Glassdoor:
                    | gd
                if c.stepstone_url
                  a.pill(href=c.stepstone_url rel="noopener noreferrer" title="StepStone Profil")
                    span.sr-only StepStone:
                    | st
                if !c.linkedin_url && !c.glassdoor_url && !c.stepstone_url
                  | —
              td.nowrap
                .buttons.nowrap
                  a.btn.warn(href=`/companies/${c._id}/edit`) Bearbeiten
    p#companies-help.muted Profil-Kürzel: in=LinkedIn, gd=Glassdoor, st=StepStone

  else
    .card.center.max-w-sm
      h2 Noch keine Unternehmen
      .buttons.center
        a.btn(href="/companies/new") Unternehmen anlegen

  script.
    (function(){
      const btn = document.getElementById('csv-import');
      if (!btn) return;
      btn.addEventListener('click', async ()=>{
        try {
          // Datei wählen
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.csv,text/csv,text/plain';
          input.onchange = async () => {
            const file = input.files && input.files[0];
            if (!file) return;
            const text = await file.text();
            const res = await fetch('/api/companies.csv', {
              method: 'POST',
              headers: { 'content-type': 'text/plain' },
              body: text
            });
            const json = await res.json();
            if (!res.ok || !json.ok) throw new Error(json.error || 'Import fehlgeschlagen');
            alert(`Import: erstellt ${json.summary.created}, aktualisiert ${json.summary.updated}, übersprungen ${json.summary.skipped}, Fehler ${json.summary.errors}`);
            location.reload();
          };
          input.click();
        } catch (e) {
          alert('Fehler beim CSV-Import: ' + (e && e.message ? e.message : e));
        }
      });
    })();