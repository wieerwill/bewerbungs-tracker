extends layout

block content
  // Kopf: Titel, Aktionen, Status-Toggles
  .card
    .card-header
      h1= job && job.title ? job.title : 'Bewerbung'
      .buttons
        if job && job._id
          a.btn(href="/jobs") Übersicht
          button.btn.success.js-copy-job(type="button", data-jobid=job._id, aria-label=`Job kopieren: ${job.title || ''}`) Kopieren
          noscript
            a.btn.success(href=`/api/jobs/${job._id}?format=markdown`) Kopieren
          a.btn.warn(href=`/jobs/${job._id}/edit`) Bearbeiten
          form(method="POST", action=`/jobs/${job._id}?_method=DELETE`, style="display:inline")
            input(type="hidden", name="_csrf", value=csrfToken)
            button.btn.danger(type="submit" aria-label="Bewerbung löschen") Löschen

  if job
    .card
        form(method="POST", action=`/jobs/${job._id}/status`, class="toolbar" aria-label="Bewerbungsstatus ändern")
          input(type="hidden", name="_csrf", value=csrfToken)
          span.muted Status
          select#job-status(name="status", required)
            option(value="discovered" selected=(job.status==='discovered')) Entdeckt
            option(value="applied" selected=(job.status==='applied')) Beworben
            option(value="answered" selected=(job.status==='answered')) Antwort erhalten
            option(value="invited" selected=(job.status==='invited')) Eingeladen
            option(value="rejected" selected=(job.status==='rejected')) Abgelehnt
            option(value="offer" selected=(job.status==='offer')) Angebot erhalten
          button.btn.secondary(type="submit") Status speichern

  if msg
    .card(role="status" aria-live="polite")
      p.muted= msg

  // Beschreibung / Notizen (Markdown)
  if job && (job.description || job.note)
    .card
      if job.description
        h2 Beschreibung
        .prose!= renderMarkdown(job.description)
      if job.note
        h2 Notizen
        .prose!= renderMarkdown(job.note)

  // Rahmen & Vergütung – nur rendern, wenn mind. 1 Feld gesetzt ist
  - const hasComp = job && (job.salary_min || job.salary_max || job.salary_target || job.salary_currency || job.salary_period || job.work_mode || job.remote_ratio != null || job.seniority || job.employment_type || job.contract_type || job.start_date || job.deadline_date || job.application_channel || job.source_url || job.referral != null)
  if hasComp
    .card
      h2 Rahmen & Vergütung
      .meta-grid
        if job.salary_min || job.salary_max
          .meta-item
            span.meta-label Gehaltsspanne&nbsp;&nbsp;
            span.meta-value
              | #{job.salary_min ? job.salary_min.toLocaleString() : '—'} – #{job.salary_max ? job.salary_max.toLocaleString() : '—'} #{job.salary_currency || 'EUR'} / #{job.salary_period==='month' ? 'Monat' : 'Jahr'}
        if job.salary_target
          .meta-item
            span.meta-label Zielgehalt&nbsp;&nbsp;
            span.meta-value #{job.salary_target.toLocaleString()} #{job.salary_currency || 'EUR'} / #{job.salary_period==='month' ? 'Monat' : 'Jahr'}
        if job.work_mode
          .meta-item
            span.meta-label Arbeitsmodus&nbsp;&nbsp;
            span.meta-value #{job.work_mode}#{job.remote_ratio != null ? ` (${job.remote_ratio}% Remote)` : ''}
        if job.seniority
          .meta-item
            span.meta-label Seniorität&nbsp;&nbsp;
            span.meta-value= job.seniority
        if job.employment_type
          .meta-item
            span.meta-label Anstellungsart&nbsp;&nbsp;
            span.meta-value= job.employment_type
        if job.contract_type
          .meta-item
            span.meta-label Vertrag&nbsp;&nbsp;
            span.meta-value= job.contract_type
        if job.start_date
          .meta-item
            span.meta-label Startdatum&nbsp;&nbsp;
            span.meta-value= job.start_date
        if job.deadline_date
          .meta-item
            span.meta-label Bewerbungsfrist&nbsp;&nbsp;
            span.meta-value= job.deadline_date
        if job.application_channel
          .meta-item
            span.meta-label Kanal&nbsp;&nbsp;
            span.meta-value= job.application_channel
        if job.source_url
          .meta-item
            span.meta-label Ausschreibung&nbsp;&nbsp;
            span.meta-value
              a(href=job.source_url rel="noopener noreferrer") Link
        if job.referral != null
          .meta-item
            span.meta-label Referral&nbsp;&nbsp;
            span.meta-value
              if job.referral
                span.badge.badge-ok Ja
              else
                span.badge.badge-no Nein

  // Zwei Spalten: Unternehmen & Kontakt
  .row.row-2
    .card
      h2 Unternehmen
      - const company = job && job.company ? job.company : {};
      - const site = company && company.website ? (company.website.startsWith('http') ? company.website : `https://${company.website}`) : null;
      .meta-grid
        if company.name
          .meta-item
            span.meta-label Name&nbsp;&nbsp;
            span.meta-value= company.name
        if site
          .meta-item
            span.meta-label Website&nbsp;&nbsp;
            span.meta-value
              a(href=site rel="noopener noreferrer")= company.website
        if company.linkedin_url
          .meta-item
            span.meta-label LinkedIn&nbsp;&nbsp;
            span.meta-value
              a(href=company.linkedin_url rel="noopener noreferrer") Profil
        if company.glassdoor_url
          .meta-item
            span.meta-label Glassdoor&nbsp;&nbsp;
            span.meta-value
              a(href=company.glassdoor_url rel="noopener noreferrer") Profil
        if company.stepstone_url
          .meta-item
            span.meta-label StepStone&nbsp;&nbsp;
            span.meta-value
              a(href=company.stepstone_url rel="noopener noreferrer") Profil
        if company.hiring_page
          .meta-item
            span.meta-label Hiring-Page&nbsp;&nbsp;
            span.meta-value
              a(href=company.hiring_page rel="noopener noreferrer") Karriere
        if company.industry
          .meta-item
            span.meta-label Branche&nbsp;&nbsp;
            span.meta-value= company.industry
        if company.size_range
          .meta-item
            span.meta-label Größe&nbsp;&nbsp;
            span.meta-value= company.size_range
        if company.career_email
          .meta-item
            span.meta-label Karriere-E-Mail&nbsp;&nbsp;
            span.meta-value
              a(href=`mailto:${company.career_email}`)= company.career_email
        if company.phone
          .meta-item
            span.meta-label Telefon&nbsp;&nbsp;
            span.meta-value
              a(href=`tel:${company.phone}`)= company.phone
        if company.street
          .meta-item
            span.meta-label Straße&nbsp;&nbsp;
            span.meta-value= company.street
        if company.city
          .meta-item
            span.meta-label Stadt&nbsp;&nbsp;
            span.meta-value= company.city
      if company.note
        .stack-12
          h3 Notizen&nbsp;&nbsp;
          .prose!= renderMarkdown(company.note)

    .card
      h2 Kontakt
      - const contact = job && job.contact ? job.contact : {};
      - const phone = contact && (contact.phone || contact.telephone) ? (contact.phone || contact.telephone) : null;
      .meta-grid
        if contact.name
          .meta-item
            span.meta-label Name&nbsp;&nbsp;
            span.meta-value= contact.name
        if contact.email
          .meta-item
            span.meta-label E-Mail&nbsp;&nbsp;
            span.meta-value
              a(href=`mailto:${contact.email}`)= contact.email
        if phone
          .meta-item
            span.meta-label Telefon&nbsp;&nbsp;
            span.meta-value
              a(href=`tel:${phone}`)= phone
      if contact.note
        .stack-12
          h3 Notizen
          .prose!= renderMarkdown(contact.note)

  // Meta/Fuß
  .card
    h2 Meta
    .meta-grid
      if job && job._id
        .meta-item
          span.meta-label Job ID&nbsp;&nbsp;
          span.meta-value= job._id
