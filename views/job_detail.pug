extends layout

block content
  // Kopf: Titel, Aktionen, Status-Toggles
  .card
    .card-header
      h1= job && job.title ? job.title : 'Bewerbung'
      .buttons
        if job && job._id
          button.btn.secondary.js-copy-job(type="button", data-jobid=job._id, aria-label=`Job kopieren: ${job.title || ''}`) Kopieren
          noscript
            a.btn.secondary(href=`/api/jobs/${job._id}?format=markdown`) Kopieren (Markdown)
          a.btn.secondary(href="/jobs") Übersicht
          a.btn.warn(href=`/jobs/${job._id}/edit`) Bearbeiten
          form(method="POST", action=`/jobs/${job._id}?_method=DELETE`, style="display:inline")
            input(type="hidden", name="_csrf", value=csrfToken)
            button.btn.danger(type="submit" aria-label="Bewerbung löschen") Löschen

    if job && (job.applied !== undefined || job.answer !== undefined)
      .stack-12
        .buttons
          form(method="POST", action=`/jobs/${job._id}/toggle/applied`, style="display:inline")
            input(type="hidden", name="_csrf", value=csrfToken)
            button.btn.secondary(
              class=job.applied ? 'active' : ''
              type="submit"
              aria-pressed=(job.applied ? 'true' : 'false')
            )= job.applied ? 'Angeschrieben ✓' : 'Noch nicht angeschrieben'
          form(method="POST", action=`/jobs/${job._id}/toggle/answer`, style="display:inline")
            input(type="hidden", name="_csrf", value=csrfToken)
            button.btn.secondary(
              class=job.answer ? 'active' : ''
              type="submit"
              aria-pressed=(job.answer ? 'true' : 'false')
            )= job.answer ? 'Antwort erhalten ✓' : 'Keine Antwort'

  if msg
    .card(role="status" aria-live="polite")
      p.muted= msg

  // Beschreibung / Notizen (Markdown)
  if job && (job.description || job.note)
    .card
      if job.description
        h2 Beschreibung
        .prose!= renderMarkdown(job.description)
      if job.note
        h2 Notizen
        .prose!= renderMarkdown(job.note)

  // Rahmen & Vergütung – nur rendern, wenn mind. 1 Feld gesetzt ist
  - const hasComp = job && (job.salary_min || job.salary_max || job.salary_target || job.salary_currency || job.salary_period || job.work_mode || job.remote_ratio != null || job.seniority || job.employment_type || job.contract_type || job.start_date || job.deadline_date || job.application_channel || job.source_url || job.referral != null)
  if hasComp
    .card
      h2 Rahmen & Vergütung
      .meta-grid
        if job.salary_min || job.salary_max
          .meta-item
            span.meta-label Gehaltsspanne
            span.meta-value
              | #{job.salary_min ? job.salary_min.toLocaleString() : '—'} – #{job.salary_max ? job.salary_max.toLocaleString() : '—'} #{job.salary_currency || 'EUR'} / #{job.salary_period==='month' ? 'Monat' : 'Jahr'}
        if job.salary_target
          .meta-item
            span.meta-label Zielgehalt
            span.meta-value #{job.salary_target.toLocaleString()} #{job.salary_currency || 'EUR'} / #{job.salary_period==='month' ? 'Monat' : 'Jahr'}
        if job.work_mode
          .meta-item
            span.meta-label Arbeitsmodus
            span.meta-value #{job.work_mode}#{job.remote_ratio != null ? ` (${job.remote_ratio}% Remote)` : ''}
        if job.seniority
          .meta-item
            span.meta-label Seniorität
            span.meta-value= job.seniority
        if job.employment_type
          .meta-item
            span.meta-label Anstellungsart
            span.meta-value= job.employment_type
        if job.contract_type
          .meta-item
            span.meta-label Vertrag
            span.meta-value= job.contract_type
        if job.start_date
          .meta-item
            span.meta-label Startdatum
            span.meta-value= job.start_date
        if job.deadline_date
          .meta-item
            span.meta-label Bewerbungsfrist
            span.meta-value= job.deadline_date
        if job.application_channel
          .meta-item
            span.meta-label Kanal
            span.meta-value= job.application_channel
        if job.source_url
          .meta-item
            span.meta-label Ausschreibung
            span.meta-value
              a(href=job.source_url rel="noopener noreferrer") Link
        if job.referral != null
          .meta-item
            span.meta-label Referral
            span.meta-value
              if job.referral
                span.badge.badge-ok Ja
              else
                span.badge.badge-no Nein

  // Zwei Spalten: Unternehmen & Kontakt
  .row.row-2
    .card
      h2 Unternehmen
      - const company = job && job.company ? job.company : {};
      - const site = company && company.website ? (company.website.startsWith('http') ? company.website : `https://${company.website}`) : null;
      .meta-grid
        if company.name
          .meta-item
            span.meta-label Name
            span.meta-value= company.name
        if site
          .meta-item
            span.meta-label Website
            span.meta-value
              a(href=site rel="noopener noreferrer")= company.website
        if company.linkedin_url
          .meta-item
            span.meta-label LinkedIn
            span.meta-value
              a(href=company.linkedin_url rel="noopener noreferrer") Profil
        if company.glassdoor_url
          .meta-item
            span.meta-label Glassdoor
            span.meta-value
              a(href=company.glassdoor_url rel="noopener noreferrer") Profil
        if company.stepstone_url
          .meta-item
            span.meta-label StepStone
            span.meta-value
              a(href=company.stepstone_url rel="noopener noreferrer") Profil
        if company.hiring_page
          .meta-item
            span.meta-label Hiring-Page
            span.meta-value
              a(href=company.hiring_page rel="noopener noreferrer") Karriere
        if company.industry
          .meta-item
            span.meta-label Branche
            span.meta-value= company.industry
        if company.size_range
          .meta-item
            span.meta-label Größe
            span.meta-value= company.size_range
        if company.career_email
          .meta-item
            span.meta-label Karriere-E-Mail
            span.meta-value
              a(href=`mailto:${company.career_email}`)= company.career_email
        if company.phone
          .meta-item
            span.meta-label Telefon
            span.meta-value
              a(href=`tel:${company.phone}`)= company.phone
        if company.street
          .meta-item
            span.meta-label Straße
            span.meta-value= company.street
        if company.city
          .meta-item
            span.meta-label Stadt
            span.meta-value= company.city
      if company.note
        .stack-12
          h3 Notizen
          .prose!= renderMarkdown(company.note)

    .card
      h2 Kontakt
      - const contact = job && job.contact ? job.contact : {};
      - const phone = contact && (contact.phone || contact.telephone) ? (contact.phone || contact.telephone) : null;
      .meta-grid
        if contact.name
          .meta-item
            span.meta-label Name
            span.meta-value= contact.name
        if contact.email
          .meta-item
            span.meta-label E-Mail
            span.meta-value
              a(href=`mailto:${contact.email}`)= contact.email
        if phone
          .meta-item
            span.meta-label Telefon
            span.meta-value
              a(href=`tel:${phone}`)= phone
      if contact.note
        .stack-12
          h3 Notizen
          .prose!= renderMarkdown(contact.note)

  // Meta/Fuß
  .card
    h2 Meta
    .meta-grid
      if job && job._id
        .meta-item
          span.meta-label Job ID
          span.meta-value= job._id
      if job && job.applied !== undefined
        .meta-item
          span.meta-label Angeschrieben
          span.meta-value
            if job.applied
              span.badge.badge-ok Ja
            else
              span.badge.badge-no Nein
      if job && job.answer !== undefined
        .meta-item
          span.meta-label Antwort
          span.meta-value
            if job.answer
              span.badge.badge-ok Ja
            else
              span.badge.badge-no Nein
