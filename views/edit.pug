extends layout

block content
  .card
    .card-header
      h1 Bewerbungsdaten bearbeiten
      if job && job.title
        p.muted #{job.title}

  if msg
    .card
      p.muted= msg

  .card
    form(action=`/jobs/${job && job._id}`, method="POST")
      input(type="hidden", name="_csrf", value=csrfToken)
    form(action=`/edit/${job && job._id}`, method="POST")
      // Stelle
      fieldset.form-section
        legend Abschnitt: Stelle
        .row.row-2
          .field
            label(for="job-title") Titel
            input#job-title(
              type="text"
              name="jobTitle"
              placeholder="z. B. Embedded Software Engineer"
              value=(job && job.title) || ''
              required
            )
          .field
            label(for="job-source") Quelle (optional)
            input#job-source(type="url", name="jobSource", placeholder="Link zur Ausschreibung", value=(job && job.source) || '')
        .field
          label(for="job-description") Beschreibung
          textarea#job-description(name="jobDescription", rows="4", placeholder="Kurzbeschreibung oder relevante Punkte …")= (job && job.description) || ''
        .field
          label(for="job-note") Notizen
          textarea#job-note(name="jobNote", rows="3", placeholder="Eigenes Fazit, nächste Schritte, Reminder …")= (job && job.note) || ''
        input#salaryMin(type="number" step="100" name="salaryMin" value=job.salary_min || '')
        select#salaryPeriod(name="salaryPeriod")
          option(value="year" selected=(job.salary_period==='year')) pro Jahr
          option(value="month" selected=(job.salary_period==='month')) pro Monat
        // usw. für alle select/checkbox Felder
        input(type="checkbox" name="referral" checked=job.referral ? true : false)

      // Zuordnung: Unternehmen & Kontakt
      fieldset.form-section
        legend Abschnitt: Zuordnung
        .row.row-2
          .field
            label(for="companyId") Unternehmen
            select#companyId(name="companyId", required)
              option(value="" disabled hidden selected=!(job && job.company_id)) — Unternehmen wählen —
              each c in companies
                option(value=c.id selected=(job && job.company_id === c.id))= c.name
            .help Unternehmen kann hier nicht neu angelegt werden – bitte unter „Unternehmen“.
          .field
            label(for="contactId") Kontaktperson (optional)
            //- initial leer; wird durch Script befüllt & auf bestehende Auswahl gesetzt
            select#contactId(name="contactId")
              option(value="" selected)= '— Kein Kontakt —'
            .help Wird nach Unternehmenswahl befüllt.

      .form-actions.buttons
        button.btn(type="submit") Speichern
        a.btn.secondary(href=`/detail/${job && job._id}`) Abbrechen

  // Client-Logik: Kontakte für gewählte Company rendern und bestehende Auswahl setzen
  script.
    (function(){
      const contactsByCompany = !{JSON.stringify(contactsByCompany || {})};
      const companySel = document.getElementById('companyId');
      const contactSel = document.getElementById('contactId');
      const selectedCompanyId = !{JSON.stringify(job && job.company_id || null)};
      const selectedContactId = !{JSON.stringify(job && job.contact_id || null)};

      function renderContacts(companyId){
        while(contactSel.firstChild) contactSel.removeChild(contactSel.firstChild);
        const optNone = document.createElement('option');
        optNone.value = '';
        optNone.textContent = '— Kein Kontakt —';
        contactSel.appendChild(optNone);

        const list = (companyId && contactsByCompany[companyId]) ? contactsByCompany[companyId] : [];
        for(const ct of list){
          const o = document.createElement('option');
          o.value = ct.id;
          o.textContent = ct.name || (ct.email || ct.phone || 'Kontakt ohne Namen');
          contactSel.appendChild(o);
        }
        // Falls bereits ein Kontakt gesetzt war, vorauswählen
        if (selectedContactId && companyId && list.some((ct)=>ct.id===selectedContactId)) {
          contactSel.value = selectedContactId;
        } else {
          contactSel.value = '';
        }
      }

      // Initial: wenn Company gewählt ist, Kontakte rendern
      if (companySel && companySel.value) {
        renderContacts(companySel.value);
      } else if (selectedCompanyId) {
        companySel.value = selectedCompanyId;
        renderContacts(selectedCompanyId);
      }

      // On change: Kontakte neu rendern und Auswahl zurücksetzen
      companySel && companySel.addEventListener('change', (e)=>{
        renderContacts(e.target.value);
      });
    })();
