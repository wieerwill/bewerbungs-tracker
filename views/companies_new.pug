extends layout

block content
  .card
    .card-header
      h1 Neues Unternehmen
      .buttons
        button.btn.secondary(type="button" id="gd-import-btn") Glassdoor importieren

  if msg
    .card(role="status" aria-live="polite")
      p.muted= msg

  .card
    form(action="/companies", method="POST" novalidate)
      input(type="hidden", name="_csrf", value=csrfToken)

      fieldset.form-section
        legend Abschnitt: Unternehmen
        .row.row-2
          .field
            label(for="companyName") Name *
            input#companyName(
              type="text"
              name="companyName"
              required
              placeholder="z. B. Corpuls"
              autocomplete="organization"
            )
            small.muted Einzigartiger Firmenname (Groß/Kleinschreibung egal).
          .field
            label(for="companyWebsite") Website
            input#companyWebsite(type="url" name="companyWebsite" placeholder="https://..." inputmode="url" autocomplete="url")
        .row.row-2
          .field
            label(for="companyStreet") Straße
            input#companyStreet(type="text" name="companyStreet" autocomplete="address-line1")
          .field
            label(for="companyCity") Stadt
            input#companyCity(type="text" name="companyCity" autocomplete="address-level2")
        .row.row-2
          .field
            label(for="companyLinkedin") LinkedIn
            input#companyLinkedin(type="url" name="companyLinkedIn" placeholder="https://www.linkedin.com/company/..." inputmode="url" autocomplete="url")
          .field
            label(for="companyGlassdoor") Glassdoor
            input#companyGlassdoor(type="url" name="companyGlassdoor" placeholder="https://www.glassdoor.de/..." inputmode="url" autocomplete="url")
        .row.row-2
          .field
            label(for="companyStepstone") StepStone
            input#companyStepstone(type="url" name="companyStepstone" placeholder="https://www.stepstone.de/..." inputmode="url" autocomplete="url")
          .field
            label(for="companyHiringpage") Hiring-Page
            input#companyHiringpage(type="url" name="companyHiringPage" placeholder="https://.../jobs" inputmode="url" autocomplete="url")
        .row.row-2
          .field
            label(for="companyIndustry") Branche
            input#companyIndustry(type="text" name="companyIndustry" placeholder="z. B. Medizintechnik")
          .field
            label(for="companySize") Größe
            input#companySize(type="text" name="companySizeRange" placeholder="z. B. 200–500")
        .row.row-2
          .field
            label(for="companyCareerEmail") Karriere-E-Mail
            input#companyCareerEmail(type="email" name="companyCareerEmail" autocomplete="email" inputmode="email")
          .field
            label(for="companyPhone") Telefon
            input#companyPhone(type="tel" name="companyPhone" autocomplete="tel" inputmode="tel")
        .field
          label(for="companyOtherLinksJson") Weitere Links (JSON)
          textarea#companyOtherLinksJson(name="companyOtherLinksJson" rows="3" placeholder='z. B. [{"label":"Kununu","url":"https://..."}]')
          small.muted Erwartet ein JSON-Array mit Objekten { label, url }.
        .field
          label(for="companyNote") Notizen (Markdown)
          textarea#companyNote(name="companyNote" rows="3")

      fieldset.form-section
        legend Abschnitt: Kontakt (optional)
        .row.row-3
          .field
            label(for="contact-name") Name
            input#contact-name(type="text" name="contactName" autocomplete="name")
          .field
            label(for="contact-email") E-Mail
            input#contact-email(type="email" name="contactEmail" autocomplete="email" inputmode="email")
          .field
            label(for="contact-phone") Telefon
            input#contact-phone(type="tel" name="contactPhone" autocomplete="tel" inputmode="tel")
        .field
          label(for="contact-note") Notizen (Markdown)
          textarea#contact-note(name="contactNote" rows="3")

      .form-actions.buttons
        button.btn(type="submit") Speichern
        a.btn.secondary(href="/companies") Abbrechen

  script.
    (function(){
      const btn = document.getElementById('gd-import-btn');
      if (!btn) return;

      const token = document.querySelector('meta[name="csrf-token"]')?.content || '';
      const set = (id, val) => { const el = document.getElementById(id); if (el && val != null) el.value = val; };

      async function applyData(c){
        set('companyName',      c.name || '');
        set('companyWebsite',   c.website || '');
        set('companyCity',      c.city || '');
        set('companySizeRange', c.size_range || '');
        set('companyIndustry',  c.industry || '');
        set('companyHiringPage',c.hiring_page || '');

        const noteEl = document.getElementById('companyNote');
        if (noteEl) {
          const prev = noteEl.value ? noteEl.value + '\\n\\n' : '';
          noteEl.value = prev + (c.note || '');
        }
      }

      async function postJson(url, payload){
        const res = await fetch(url, {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'Content-Type':'application/json', 'X-CSRF-Token': token },
          body: JSON.stringify(payload)
        });
        const ct = res.headers.get('content-type') || '';
        const json = ct.includes('application/json') ? await res.json() : { ok:false, error:'Unerwartete Antwort' };
        if (!res.ok || !json.ok) throw new Error(json.error || 'Fehler');
        return json.data;
      }

      btn.addEventListener('click', async () => {
        try {
          const url = prompt('Glassdoor-URL eingeben:');
          if (!url) return;

          // 1) Versuch: direkten Fetch
          try {
            const data = await postJson('/api/import/glassdoor', { url });
            await applyData(data);
            alert('Glassdoor-Daten eingefügt. Bitte prüfen & speichern.');
            return;
          } catch (e) {
            // 2) Fallback: HTML einkleben
            if (!confirm('Direkter Abruf fehlgeschlagen (z. B. 403). HTML-Quelltext einkleben?')) return;
            alert('Öffne die Glassdoor-Seite, drücke Strg+U (Seitenquelltext), alles kopieren & hier einfügen.');
            const html = prompt('Füge den kompletten HTML-Quelltext hier ein:');
            if (!html) return;
            const data = await postJson('/api/import/glassdoor', { url, html });
            await applyData(data);
            alert('Glassdoor-Daten (aus HTML) eingefügt. Bitte prüfen & speichern.');
          }
        } catch (err) {
          alert('Fehler beim Import: ' + (err && err.message ? err.message : err));
        }
      });
    })();